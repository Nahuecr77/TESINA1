<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Stock de Computadoras</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header del dashboard -->
        <div class="dashboard-header">
            <div class="dashboard-logo">
                <i class="fas fa-laptop"></i>
            </div>
            <h1 class="dashboard-title">STOCK DE COMPUTADORAS</h1>
            <div class="dashboard-user">
                <i class="fas fa-user"></i>
                <span>{{ session.usuario_nombre }}</span>
            </div>
        </div>

        <!-- Navegación principal -->
        <div class="dashboard-nav">
            <a href="{{ url_for('index') }}" class="nav-btn">
                <i class="fas fa-home"></i>
                Inicio
            </a>
            <a href="{{ url_for('todas_computadoras') }}" class="nav-btn">
                <i class="fas fa-list"></i>
                Todas las Computadoras
            </a>
            <a href="{{ url_for('computadoras_en_uso') }}" class="nav-btn">
                <i class="fas fa-desktop"></i>
                En Uso
            </a>
            <a href="{{ url_for('computadoras_libres') }}" class="nav-btn">
                <i class="fas fa-check-circle"></i>
                Libres
            </a>
            <a href="{{ url_for('observaciones') }}" class="nav-btn">
                <i class="fas fa-sticky-note"></i>
                Observaciones
            </a>
            {% if session.usuario_rol == 'admin' %}
            <a href="{{ url_for('listar_usuarios') }}" class="nav-btn admin-btn">
                <i class="fas fa-users-cog"></i>
                Usuarios
            </a>
            {% endif %}
        </div>

        <!-- Acciones principales -->
        <div class="dashboard-actions">
            <a href="{{ url_for('nueva_computadora') }}" class="add-btn">
                <i class="fas fa-plus"></i>
                Agregar Nueva Computadora
            </a>
            
            <!-- Filtro por estado -->
            <div class="filter-section">
                <h3><i class="fas fa-filter"></i> Filtrar por Estado</h3>
                <form method="get" action="{{ url_for('filtro_estado') }}" class="filter-form">
                    <select name="estado" class="filter-select">
                        <option value="todos">Todos los Estados</option>
                        <option value="Libre">🟢 Libre</option>
                        <option value="En Uso">🟡 En Uso</option>
                        <option value="Mantenimiento">🟠 Mantenimiento</option>
                        <option value="Fuera de Servicio">🔴 Fuera de Servicio</option>
                    </select>
                    <button type="submit" class="filter-btn">
                        <i class="fas fa-search"></i>
                        Filtrar
                    </button>
                </form>
            </div>
        </div>

        <!-- Listado de computadoras con funcionalidad de edición -->
        <div class="computadoras-section">
            <h2><i class="fas fa-list"></i> Listado de Computadoras</h2>
            
            {% if computadoras %}
            <div class="table-container">
                <table class="computadoras-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                            <th>Número de Serie</th>
                            <th>Ubicación</th>
                            <th>Estado</th>
                            <th>Fecha Adquisición</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for compu in computadoras %}
                        <tr data-computadora-id="{{ compu.id }}">
                            <td>
                                <span class="field-display">{{ compu.nombre or 'N/A' }}</span>
                                <input type="text" class="field-edit" value="{{ compu.nombre or '' }}" style="display: none;">
                            </td>
                            <td>
                                <span class="field-display">{{ compu.marca or 'N/A' }}</span>
                                <input type="text" class="field-edit" value="{{ compu.marca or '' }}" style="display: none;">
                            </td>
                            <td>
                                <span class="field-display">{{ compu.modelo or 'N/A' }}</span>
                                <input type="text" class="field-edit" value="{{ compu.modelo or '' }}" style="display: none;">
                            </td>
                            <td>
                                <span class="field-display">{{ compu.numero_serie or 'N/A' }}</span>
                                <input type="text" class="field-edit" value="{{ compu.numero_serie or '' }}" style="display: none;">
                            </td>
                            <td>
                                <span class="field-display">{{ compu.ubicacion or 'N/A' }}</span>
                                <input type="text" class="field-edit" value="{{ compu.ubicacion or '' }}" style="display: none;">
                            </td>
                            <td>
                                <span class="field-display status-{{ compu.estado.lower().replace(' ', '-') }}">
                                    {% if compu.estado == 'Libre' %}🟢 Libre
                                    {% elif compu.estado == 'En Uso' %}🟡 En Uso
                                    {% elif compu.estado == 'Mantenimiento' %}🟠 Mantenimiento
                                    {% elif compu.estado == 'Fuera de Servicio' %}🔴 Fuera de Servicio
                                    {% else %}{{ compu.estado or 'N/A' }}
                                    {% endif %}
                                </span>
                                <select class="field-edit status-select" style="display: none;">
                                    <option value="Libre" {% if compu.estado == 'Libre' %}selected{% endif %}>🟢 Libre</option>
                                    <option value="En Uso" {% if compu.estado == 'En Uso' %}selected{% endif %}>🟡 En Uso</option>
                                    <option value="Mantenimiento" {% if compu.estado == 'Mantenimiento' %}selected{% endif %}>🟠 Mantenimiento</option>
                                    <option value="Fuera de Servicio" {% if compu.estado == 'Fuera de Servicio' %}selected{% endif %}>🔴 Fuera de Servicio</option>
                                </select>
                            </td>
                            <td>
                                <span class="field-display">{{ compu.fecha_adquisicion or 'N/A' }}</span>
                                <input type="date" class="field-edit" value="{{ compu.fecha_adquisicion or '' }}" style="display: none;">
                            </td>
                            <td>
                                <span class="field-display">{{ compu.observaciones or 'N/A' }}</span>
                                <textarea class="field-edit" rows="2" style="display: none;">{{ compu.observaciones or '' }}</textarea>
                            </td>
                            <td class="actions-cell">
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="toggleEdit({{ compu.id }})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="save-btn" onclick="saveChanges({{ compu.id }})" style="display: none;" title="Guardar">
                                        <i class="fas fa-save"></i>
                                    </button>
                                    <button class="cancel-btn" onclick="cancelEdit({{ compu.id }})" style="display: none;" title="Cancelar">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="delete-btn" onclick="deleteComputadora({{ compu.id }})" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-computadoras">
                <i class="fas fa-inbox"></i>
                <p>No hay computadoras registradas</p>
                <a href="{{ url_for('nueva_computadora') }}" class="add-btn">
                    <i class="fas fa-plus"></i>
                    Agregar Primera Computadora
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Enlace de logout -->
        <div class="dashboard-footer">
            <a href="{{ url_for('logout') }}" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                Cerrar Sesión
            </a>
        </div>

        <!-- Mensajes flash -->
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }}">
                    <i class="fas fa-info-circle"></i>
                    {{ message }}
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación</h3>
            <p>¿Está seguro de que desea eliminar esta computadora?</p>
            <p class="modal-computadora-info"></p>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancelar</button>
                <button class="btn-confirm" onclick="confirmDelete()">Eliminar</button>
            </div>
        </div>
    </div>

    <script>
        let editingComputadoraId = null;
        let originalData = {};

        function toggleEdit(computadoraId) {
            const row = document.querySelector(`tr[data-computadora-id="${computadoraId}"]`);
            const isEditing = row.classList.contains('editing');
            
            if (isEditing) {
                // Ya está editando, cancelar
                cancelEdit(computadoraId);
            } else {
                // Iniciar edición
                startEdit(computadoraId);
            }
        }

        function startEdit(computadoraId) {
            const row = document.querySelector(`tr[data-computadora-id="${computadoraId}"]`);
            
            // Guardar datos originales
            originalData[computadoraId] = {};
            const fields = row.querySelectorAll('.field-edit');
            fields.forEach(field => {
                const fieldName = field.classList.contains('status-select') ? 'estado' : 
                                 field.tagName === 'TEXTAREA' ? 'observaciones' : 
                                 field.name || field.type;
                originalData[computadoraId][fieldName] = field.value;
            });

            // Mostrar campos de edición
            row.querySelectorAll('.field-display').forEach(display => display.style.display = 'none');
            row.querySelectorAll('.field-edit').forEach(edit => edit.style.display = 'inline-block');
            
            // Mostrar botones de guardar/cancelar
            row.querySelector('.edit-btn').style.display = 'none';
            row.querySelector('.save-btn').style.display = 'inline-block';
            row.querySelector('.cancel-btn').style.display = 'inline-block';
            
            row.classList.add('editing');
            editingComputadoraId = computadoraId;
        }

        function cancelEdit(computadoraId) {
            const row = document.querySelector(`tr[data-computadora-id="${computadoraId}"]`);
            
            // Restaurar datos originales
            if (originalData[computadoraId]) {
                const fields = row.querySelectorAll('.field-edit');
                fields.forEach(field => {
                    const fieldName = field.classList.contains('status-select') ? 'estado' : 
                                     field.tagName === 'TEXTAREA' ? 'observaciones' : 
                                     field.name || field.type;
                    if (originalData[computadoraId][fieldName] !== undefined) {
                        field.value = originalData[computadoraId][fieldName];
                    }
                });
            }

            // Ocultar campos de edición
            row.querySelectorAll('.field-display').forEach(display => display.style.display = 'inline');
            row.querySelectorAll('.field-edit').forEach(edit => edit.style.display = 'none');
            
            // Ocultar botones de guardar/cancelar
            row.querySelector('.edit-btn').style.display = 'inline-block';
            row.querySelector('.save-btn').style.display = 'none';
            row.querySelector('.cancel-btn').style.display = 'none';
            
            row.classList.remove('editing');
            editingComputadoraId = null;
            delete originalData[computadoraId];
        }

        function saveChanges(computadoraId) {
            const row = document.querySelector(`tr[data-computadora-id="${computadoraId}"]`);
            const formData = new FormData();
            
            // Recopilar datos del formulario
            const nombre = row.querySelector('td:nth-child(1) .field-edit').value;
            const marca = row.querySelector('td:nth-child(2) .field-edit').value;
            const modelo = row.querySelector('td:nth-child(3) .field-edit').value;
            const numero_serie = row.querySelector('td:nth-child(4) .field-edit').value;
            const ubicacion = row.querySelector('td:nth-child(5) .field-edit').value;
            const estado = row.querySelector('td:nth-child(6) .field-edit').value;
            const fecha_adquisicion = row.querySelector('td:nth-child(7) .field-edit').value;
            const observaciones = row.querySelector('td:nth-child(8) .field-edit').value;
            
            formData.append('nombre', nombre);
            formData.append('marca', marca);
            formData.append('modelo', modelo);
            formData.append('numero_serie', numero_serie);
            formData.append('ubicacion', ubicacion);
            formData.append('estado', estado);
            formData.append('fecha_adquisicion', fecha_adquisicion);
            formData.append('observaciones', observaciones);
            
            // Enviar datos al servidor
            fetch(`/computadora/editar/${computadoraId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Actualizar campos de visualización
                    updateDisplayFields(row, {
                        nombre, marca, modelo, numero_serie, 
                        ubicacion, estado, fecha_adquisicion, observaciones
                    });
                    
                    // Salir del modo edición
                    cancelEdit(computadoraId);
                    
                    // Mostrar mensaje de éxito
                    showMessage('Computadora actualizada correctamente', 'success');
                } else {
                    showMessage('Error al actualizar: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error de conexión al actualizar', 'error');
            });
        }

        function updateDisplayFields(row, data) {
            // Actualizar nombre
            row.querySelector('td:nth-child(1) .field-display').textContent = data.nombre || 'N/A';
            
            // Actualizar marca
            row.querySelector('td:nth-child(2) .field-display').textContent = data.marca || 'N/A';
            
            // Actualizar modelo
            row.querySelector('td:nth-child(3) .field-display').textContent = data.modelo || 'N/A';
            
            // Actualizar número de serie
            row.querySelector('td:nth-child(4) .field-display').textContent = data.numero_serie || 'N/A';
            
            // Actualizar ubicación
            row.querySelector('td:nth-child(5) .field-display').textContent = data.ubicacion || 'N/A';
            
            // Actualizar estado
            const estadoDisplay = row.querySelector('td:nth-child(6) .field-display');
            estadoDisplay.className = `field-display status-${data.estado.toLowerCase().replace(' ', '-')}`;
            if (data.estado === 'Libre') estadoDisplay.innerHTML = '🟢 Libre';
            else if (data.estado === 'En Uso') estadoDisplay.innerHTML = '🟡 En Uso';
            else if (data.estado === 'Mantenimiento') estadoDisplay.innerHTML = '🟠 Mantenimiento';
            else if (data.estado === 'Fuera de Servicio') estadoDisplay.innerHTML = '🔴 Fuera de Servicio';
            else estadoDisplay.textContent = data.estado || 'N/A';
            
            // Actualizar fecha de adquisición
            row.querySelector('td:nth-child(7) .field-display').textContent = data.fecha_adquisicion || 'N/A';
            
            // Actualizar observaciones
            row.querySelector('td:nth-child(8) .field-display').textContent = data.observaciones || 'N/A';
        }

        function deleteComputadora(computadoraId) {
            const row = document.querySelector(`tr[data-computadora-id="${computadoraId}"]`);
            const nombre = row.querySelector('td:nth-child(1) .field-display').textContent;
            const numeroSerie = row.querySelector('td:nth-child(4) .field-display').textContent;
            
            // Mostrar modal de confirmación
            document.querySelector('.modal-computadora-info').textContent = 
                `Computadora: ${nombre} (${numeroSerie})`;
            document.getElementById('deleteModal').style.display = 'block';
            
            // Guardar ID para confirmación
            window.pendingDeleteId = computadoraId;
        }

        function confirmDelete() {
            const computadoraId = window.pendingDeleteId;
            
            fetch(`/computadora/eliminar/${computadoraId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Eliminar fila de la tabla
                    const row = document.querySelector(`tr[data-computadora-id="${computadoraId}"]`);
                    row.remove();
                    
                    showMessage('Computadora eliminada correctamente', 'success');
                } else {
                    showMessage('Error al eliminar: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error de conexión al eliminar', 'error');
            });
            
            closeDeleteModal();
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            window.pendingDeleteId = null;
        }

        function showMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            
            document.querySelector('.flash-messages').appendChild(alertDiv);
            
            // Auto-remover después de 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target === modal) {
                closeDeleteModal();
            }
        }
    </script>
    
    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
</body>
</html>
